<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Chat App with Call</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    #chat { border: 1px solid #ccc; height: 250px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    #messageInput { width: 80%; padding: 10px; }
    #sendBtn, #audioCallBtn, #videoCallBtn { padding: 10px 15px; margin-top: 5px; }
    video { width: 45%; margin: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>Private Chat App</h2>

<label for="roomInput">Enter Room ID (e.g. user1_user2):</label><br />
<input type="text" id="roomInput" placeholder="Room ID" />
<button id="joinBtn">Join Room</button>

<div id="chat"></div>
<input type="text" id="messageInput" placeholder="Type message..." disabled />
<button id="sendBtn" disabled>Send</button>
<br />
<button id="audioCallBtn" disabled>Start Audio Call</button>
<button id="videoCallBtn" disabled>Start Video Call</button>
<br />
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let room = '';
let localStream;
let peerConnection;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

const joinBtn = document.getElementById('joinBtn');
const roomInput = document.getElementById('roomInput');
const chat = document.getElementById('chat');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const audioCallBtn = document.getElementById('audioCallBtn');
const videoCallBtn = document.getElementById('videoCallBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

joinBtn.onclick = () => {
  room = roomInput.value.trim();
  if (room) {
    socket.emit('join_room', room);
    chat.innerHTML += `<p><em>Joined room: ${room}</em></p>`;
    messageInput.disabled = false;
    sendBtn.disabled = false;
    roomInput.disabled = true;
    joinBtn.disabled = true;
    audioCallBtn.disabled = false;
    videoCallBtn.disabled = false;
  }
};

sendBtn.onclick = () => {
  const msg = messageInput.value.trim();
  if (msg) {
    socket.emit('chat_message', { room, message: msg });
    messageInput.value = '';
  }
};

socket.on('chat_message', msg => {
  const p = document.createElement('p');
  p.textContent = msg;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
});

socket.on('peer_joined', () => {
  console.log('Peer joined');
});

// ==== Call System ====

async function startCall(video = true) {
  localStream = await navigator.mediaDevices.getUserMedia({
    video,
    audio: true
  });
  localVideo.srcObject = localStream;

  peerConnection = new RTCPeerConnection(config);
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  peerConnection.ontrack = event => {
    remoteVideo.srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = event => {
    if (event.candidate) {
      socket.emit('ice-candidate', { room, candidate: event.candidate });
    }
  };

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit('offer', { room, offer });
}

audioCallBtn.onclick = () => startCall(false);
videoCallBtn.onclick = () => startCall(true);

socket.on('offer', async offer => {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;

  peerConnection = new RTCPeerConnection(config);
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  peerConnection.ontrack = event => {
    remoteVideo.srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = event => {
    if (event.candidate) {
      socket.emit('ice-candidate', { room, candidate: event.candidate });
    }
  };

  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit('answer', { room, answer });
});

socket.on('answer', async answer => {
  await peerConnection.setRemoteDescription(answer);
});

socket.on('ice-candidate', async candidate => {
  if (candidate) {
    await peerConnection.addIceCandidate(candidate);
  }
});
</script>

</body>
</html>
